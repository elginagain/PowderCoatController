<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oven Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        /* Base styling */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #222;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 90%;
            margin: auto;
            padding: 20px;
            position: relative;
        }
        /* Settings gear icon in top-right corner */
        #openSettings {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 36px;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        h1 {
            margin: 0;
            padding: 20px 0 10px 0;
        }
        /* Sections with border */
        .section {
            border: 2px solid #fff;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
        }
        /* Light icon centered */
        #toggleLight {
            font-size: 36px;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
        }
        /* Oven Control layout */
        .oven-control {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
        }
        .oven-column {
            text-align: center;
        }
        .oven-column h2 {
            margin-bottom: 10px;
        }
        /* Temperature arrows and display */
        .temp-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .temp-set {
            font-size: 48px;
            border: 2px solid #fff;
            padding: 10px;
            width: 200px;      /* Increased from 150px to 200px */
            text-align: center;
            background: #333;
            cursor: pointer;   /* for keypad */
            white-space: nowrap;  /* Prevent text wrapping */
        }
        .arrow {
            font-size: 36px;
            cursor: pointer;
            user-select: none;
        }
        .arrow:hover {
            color: #ffcc00;
        }
        /* Status & buttons */
        .status {
            margin: 10px;
            font-size: 24px;
        }
        .button {
            font-size: 24px;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            background: #333;
            border: 2px solid #fff;
            color: #fff;
            border-radius: 8px;
        }
        .button:hover {
            background: #444;
        }
        /* Timer */
        .timer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .timer-set {
            font-size: 48px;
            border: 2px solid #fff;
            padding: 10px;
            width: 150px;
            text-align: center;
            background: #333;
            cursor: pointer; /* for keypad */
        }
        /* Keypad overlay */
        .keypad {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #444;
            padding: 10px;
            border-radius: 10px;
        }
        .keypad button {
            font-size: 24px;
            padding: 15px;
            margin: 5px;
        }
        /* Graph */
        #tempGraph {
            max-width: 600px;
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Settings gear -->
        <button id="openSettings" onclick="location.href='/settings'">‚öôÔ∏è</button>

        <h1>Oven Control</h1>

        <!-- Light icon -->
        <button id="toggleLight">üîÜ</button>

        <!-- Oven Control Section -->
        <div class="section">
            <div class="oven-control">
                <!-- Left: Set Temperature -->
                <div class="oven-column">
                    <h2>Control</h2>
                    <div class="temp-controls">
                        <span class="arrow" id="decreaseTemp">&#9664;</span>
                        <div id="setTemp" class="temp-set">450</div>
                        <span class="arrow" id="increaseTemp">&#9654;</span>
                    </div>
                </div>
                <!-- Right: Current Temperature -->
                <div class="oven-column">
                    <h2>Current Temperature</h2>
                    <div id="currentTemp" class="temp-set">450</div>
                </div>
            </div>

            <p class="status" id="ovenStatus">Stopped</p>
            <button class="button" id="toggleOven">Start Oven</button>
        </div>

        <!-- Baking Timer Section -->
        <div class="section">
            <h2>Baking Timer</h2>
            <div class="timer-controls">
                <span class="arrow" id="decreaseTime">&#9664;</span>
                <div id="setTimer" class="timer-set">00:30</div>
                <span class="arrow" id="increaseTime">&#9654;</span>
            </div>
            <p class="status" id="timerStatus">Stopped</p>
            <button class="button" id="toggleTimer">Start Timer</button>
        </div>

        <!-- Temperature Graph -->
        <button class="button" onclick="location.href='/temperature_graph'">View Temperature Graph</button>
        <canvas id="tempGraph"></canvas>
    </div>

    <!-- Keypad Overlay -->
    <div id="keypad" class="keypad">
        <input type="text" id="keypad-input" readonly>
        <br>
        <button onclick="enterValue(1)">1</button>
        <button onclick="enterValue(2)">2</button>
        <button onclick="enterValue(3)">3</button>
        <br>
        <button onclick="enterValue(4)">4</button>
        <button onclick="enterValue(5)">5</button>
        <button onclick="enterValue(6)">6</button>
        <br>
        <button onclick="enterValue(7)">7</button>
        <button onclick="enterValue(8)">8</button>
        <button onclick="enterValue(9)">9</button>
        <br>
        <button onclick="clearKeypad()">C</button>
        <button onclick="enterValue(0)">0</button>
        <button onclick="setKeypadValue()">OK</button>
    </div>

    <script>
    $(document).ready(function() {
        let timerRunning = false;
        let timerSeconds = 0;
        let timerInterval;

        // Function to update current sensor temperature
        function updateCurrentTemp() {
            $.ajax({
                url: '/current_temperature',
                method: 'GET',
                success: function(data) {
                    $("#currentTemp").text(data.current_temperature.toFixed(2) + " ¬∞F");
                },
                error: function() {
                    $("#currentTemp").text("Error");
                }
            });
        }
        setInterval(updateCurrentTemp, 1000);
        updateCurrentTemp();

        // Function to update oven status from the server
        function updateOvenStatus() {
            $.ajax({
                url: '/status',
                method: 'GET',
                success: function(data) {
                    $("#toggleOven").text(data.oven_on ? "Stop Oven" : "Start Oven");
                    $("#ovenStatus").text(data.oven_on ? "Running" : "Stopped");
                },
                error: function() {
                    console.error("Error fetching oven status.");
                }
            });
        }
        // Call updateOvenStatus on page load and every 5 seconds.
        updateOvenStatus();
        setInterval(updateOvenStatus, 5000);

        // Light Toggle
        $("#toggleLight").click(function() {
            $.post("/toggle_light", function(response) {
                $("#toggleLight").text(response.light_on ? "üí°" : "üîÜ");
            });
        });

        // Oven Toggle
        $("#toggleOven").click(function() {
            console.log("toggle oven clicked");
            $.post("/power", function(response) {
                console.log("toggle oven response:", response);
                $("#toggleOven").text(response.oven_on ? "Stop Oven" : "Start Oven");
                $("#ovenStatus").text(response.oven_on ? "Running" : "Stopped");
            });
        });

        // Timer Start/Stop
        $("#toggleTimer").click(function() {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
                $("#toggleTimer").text("Start Timer");
                $("#timerStatus").text("Stopped");
            } else {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    if (timerSeconds > 0) {
                        timerSeconds--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        timerRunning = false;
                        $("#toggleTimer").text("Start Timer");
                        $("#timerStatus").text("Stopped");
                    }
                }, 1000);
                $("#toggleTimer").text("Stop Timer");
                $("#timerStatus").text("Running");
            }
        });

        function updateTimerDisplay() {
            let minutes = Math.floor(timerSeconds / 60);
            let seconds = timerSeconds % 60;
            $("#setTimer").text(
                (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds
            );
        }

        // Timer Increase/Decrease
        $("#increaseTime").click(function() {
            timerSeconds += 300;
            updateTimerDisplay();
        });
        $("#decreaseTime").click(function() {
            if (timerSeconds >= 300) {
                timerSeconds -= 300;
                updateTimerDisplay();
            }
        });

        // Temperature Increase/Decrease with proper JSON call
        $("#increaseTemp").click(function() {
            let temp = parseInt($("#setTemp").text()) || 0;
            temp += 25;
            $("#setTemp").text(temp);
            updateSetTemperature(temp);
        });
        $("#decreaseTemp").click(function() {
            let temp = parseInt($("#setTemp").text()) || 0;
            temp -= 25;
            $("#setTemp").text(temp);
            updateSetTemperature(temp);
        });

        function updateSetTemperature(newTemp) {
            $.ajax({
                url: "/set_temperature",
                method: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ temperature: newTemp }),
                dataType: "json",
                success: function(response) {
                    console.log("Temperature updated:", response);
                },
                error: function(xhr, status, error) {
                    console.error("Error updating temperature:", status, error);
                }
            });
        }

        // Keypad Handlers
        $(".temp-set, .timer-set").click(function() {
            $("#keypad").fadeIn();
            $("#keypad").data("target", this);
            $("#keypad-input").val("");
        });

        window.enterValue = function(value) {
            $("#keypad-input").val($("#keypad-input").val() + value);
        };

        window.clearKeypad = function() {
            $("#keypad-input").val("");
        };

        window.setKeypadValue = function() {
            let target = $("#keypad").data("target");
            let newValue = parseInt($("#keypad-input").val());
            if (!isNaN(newValue)) {
                $(target).text(newValue);
                if ($(target).attr("id") === "setTimer") {
                    timerSeconds = newValue * 60;
                    updateTimerDisplay();
                } else if ($(target).attr("id") === "setTemp") {
                    updateSetTemperature(newValue);
                }
            }
            $("#keypad").fadeOut();
        };
    });
    </script>
</body>
</html>
